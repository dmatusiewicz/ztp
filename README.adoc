# Zawansowane Języki Programowania, 17/18

:experimental:
:imagesdir: ./images
:source-highlighter: pygments
:pygments-style: github
:icons: font

// https://www.showmax.com/pol/tvseries/466ad0jw-mr-robot

[quote, Edsger W. Dijkstra, On the cruelty of really teaching computer science]
____
*The usual way in which we plan today for tomorrow is in yesterday's vocabulary.*
We do so, because we try to get away with the concepts we are familiar with and
that have acquired their meanings in our past experience. Of course, the words
and the concepts don't quite fit because our future differs from our past, but
then we stretch them a little bit.
____

{nbsp}

Literatura

. Greg Young, https://vimeo.com/108441214/description?__s=jvsvsq3unktoidfpqwzm[The art of destroying software], Vimeo
. Refactoring https://martinfowler.com/books/refactoringRubyEd.html[Ruby Edition]
  by Jay Fields, Shane Harvie, and Martin Fowler (with Kent Beck),
  https://martinfowler.com/books/refactoring.html[Java Edition]
  by Martin Fowler (with Kent Beck, John Brant, William Opdyke, and Don Roberts)
. http://helion.pl/ksiazki/czysty-kod-podrecznik-dobrego-programisty-robert-c-martin,czykov.htm#format/e[Czysty kod. Podręcznik dobrego programisty]
  by Robert C. Martin (Uncle Bob),
. https://www.sandimetz.com/99bottles[99 Bottles off OOP] by https://www.sandimetz.com[Sandi Metz]
. http://www.cs.utexas.edu/~EWD/ewd10xx/EWD1036.PDF[On the cruelty of really teaching computer science]
  by Edsger W. Dijkstra

Narzędzia

. https://www.learnenough.com[Learn Enough] by Michael Hartl
. Git
.. https://git-scm.com/book/en/v2[Pro Git book] by by Scott Chacon and Ben Straub
... https://git-scm.com/book/en/v2/GitHub-Account-Setup-and-Configuration[GitHub – Account Setup and Configuration]
..
. Linters
. Code smell detectors (and brothers & sisters)
.. https://github.com/troessner/reek[Reek] (for Ruby language)
.. https://github.com/bbatsov/rubocop[RuboCop] – static code analyzer & style guide
.. https://github.com/seattlerb/flog[Flog] – reports the most tortured code in an easy to read pain report – the higher the score, the more pain the code is in
.. https://github.com/seattlerb/flay[Flay] – analyzes code for structural similarities
.. https://github.com/meganemura/sloc[SLOC] – a tool for counting source lines of code
. Editors
.. https://atom.io[Atom]


## Object Oriented Design

The foundation of an object-oriented system is the *message*,
but the most visible organizational structure
in a a class-based OO language (Ruby) is the *class*.

[quote, S. Metz, Practical Object Oriented Design in Ruby]
____
If your application succeeds many of the decisions you
make today will need to be changed later. […] +
Design is more the art of *preserving changeability*
than it is the act of achieving perfection.
____

{nbsp}

So, how to create classes to allow for easy changes?

// The classes we create will affect how we think about your application *forever*.


### The BDD micro-process

[quote]
____
You will never know less than you know right now.
____

|===
| RED        | Write a new test and see it fail.
| GREEN      | Get all tests passing, using the most naive approach you can see.
| *REFACTOR* | Transition to the simplest design that passes the current tests,
               by removing any introduced smells.
| _repeat_   |
|===

[caption=""]
.A quantum point of view on programming
image::bdd_mini.jpg[A quantum point of view on programming, 600, 600]

Programmer State Attention Exclusion Principle:: A programmer
attentions should not occupy different states simultaneously.


## Refactoring

Refactoring to metoda *bezpiecznego* udoskonalania *istniejącego kodu*.
Innymi słowami, w trakcie refactoringu poprawiamy kod udoskonalając jego
wewnętrzną strukturę i nie zmieniając jego działania (semantyki).

W książce
https://martinfowler.com/books/refactoringRubyEd.html[Refactoring – RubyEdition]
opisano ok. 80 refactoringów.

W trakcie refactoringu zmienia się nasze rozumienie cudzego kodu
Dlatego kod po refactoringu jest łatwiejszy w zrozumieniu
i łatwiej go rozszerzać (szybciej piszemy nowy kod i robimy mniej błędów).


## A refactoring example – _Hide Delegate_

Refactorings are designed to be safe transformations.
But mistakes happens. So, use Git.

.hide_delegate.rb
```ruby
class Rectangle
  attr_reader :top_left, :width, :height

  def initialize top_left, width, height
    @top_left = top_left
    @width = width
    @height = height
  end
end

class Point
  attr_reader :x, :y

  def initialize x, y
    @x = x
    @y = y
  end
end
```

To find the _x_-coordinate of a rectangle’s left coordinate we have to use:
```ruby
rect = Rectangle.new Point.new(4, 5), 3, 2
left_x = rect.top_left.x
```
and wy may want to hide this delegation.

The suggested steps for _Hide Delegate_ are following:

1. Create a delegating method on the `Rectangle` class. *Test*.
2. For each client of the delegate adjust it to call the new method. *Test*.
3. If no client needs to access the delegate any longer
  remove the `Rectangle` accessor for the delegate. *Test*.

.Step 1
```ruby
class Rectangle
  def left_edge
    @top_left.x
  end
end
```

.Step 2
```ruby
left_x = rect.left_edge
```

.Step 3
```ruby
class Rectangle
  attr_reader :width, :height
end
```


## Code smells ➨ Refactorings

Code smells suggest refactorings.

NOTE: *Move Method*, *Extract Class*, *Move Field*, *Extract Method*: probably,
these refactorings are responsible for fixing the most smells.

WARNING: Quite a few refactorings are not mentioned by any
of the smells.

Lista wszystkich *code smells* z książki _Refactoring – Ruby ed._.

[cols="^10s,80", options="header", caption=""]
|===
| #   | Code Smell

|     | Duplicated Code
|     | Long Method
|     | Large Class
|     | Long Parameter List
|     | Divergent Change
|     | Shotgun Surgery
|     | Feature Envy
|     | Data Clumps
|     | Primitive Obsession
|     | Case Statements
|     | Parallel Inheritance Hierarchies
|     | Lazy Class
|     | Speculative Generality
|     | Temporary Field
|     | Message Chains
|     | Middle Man
|     | Inappropriate Intimacy
|     | Alternative Classes with Different Interfaces
|     | Incomplete Library Class
|     | Data Class
|     | Refused Bequest
|     | Comments
|     | Metaprogramming Madness
|     | Disjointed API
|     | Repetitive Boilerplate
|===


## The refactoring cycle

.Source: Refactoring in Ruby by W. C. Wake & K. Rutherford
[verse]
start with working (tested) code
while the design can be simplified
  choose the worst smell
  select a refactoring that will address the smell
  apply the refactoring
  (check that tests still pass)


IMPORTANT: This approach to refactoring does not guarantee to
get the ideal design, because you can not reach a global
maximum by looking at local properties.

link:code_smells.adoc[Table of refactorings that will address the code smells].


## Automatyczne wyszukiwanie code smells w kodzie

Przykład automatycznego wyszukiwania code smells w pliku
za pomocą programu _reek_ –
https://github.com/troessner/reek[Code smell detector for Ruby].

.smelly.rb
[source,ruby]
----
# Smelly class
class Smelly
  # This will reek of UncommunicativeMethodName
  def x
    y = 10 # This will reek of UncommunicativeVariableName
  end
end
----

```sh
reek smelly.rb
Inspecting 1 file(s):
S

smelly.rb -- 2 warnings:
  [4]:UncommunicativeMethodName: Smelly#x has the name 'x' [https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Method-Name.md]
  [5]:UncommunicativeVariableName: Smelly#x has the variable name 'y' [https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md]
```

## Rediscovering code simplicity

Do wyszukiwania _pain in code_ możemy użyć narzędzia  *flog]* – the higher the
score, the more pain the code is in. Przykład jest na stronie
https://github.com/seattlerb/flog[Flog].

.verse.rb
```ruby
def verse(n)
  "#{n == 0 ? 'No more' : n} bottle#{'s' if n != 1}" +
  " of beer on the wall, " +
  "#{n == 0 ? 'no more' : n} bottle#{'s' if n != 1} of beer.\n" +
  "#{n > 0  ? "Take #{n > 1 ? 'one' : 'it'} down and pass it around"
            : "Go to the store and buy some more"}, " +
  "#{n-1 < 0 ? 99 : n-1 == 0 ? 'no more' : n-1} bottle#{'s' if n-1 != 1}"+
  " of beer on the wall.\n"
end
```

```sh
flog -ad verse.rb # --all --details
    36.2: flog total
    36.2: flog/method average

    36.2: main#verse                       verse.rb:1-8
    15.2:   branch
     7.0:   +
     6.5:   -
     5.3:   ==
     5.2:   !=
     4.1:   lit_fixnum
     3.3:   >
     1.4:   <
```


## Exercises to try – Smell of the Week

Więcej przykładowych programów do wybróbowania z programem _reek_ można
znależć na http://www.codequizzes.com/ruby[Learn Ruby]
(Beginner, Intermediate, Advanced, *TDD*).

Można też spróbować swoich sił na zadaniach z portalu http://exercism.io[Exercism].

```sh
exercism list ruby
exercism fetch ruby hello-world
```
